 go run cmd/api_server/main.go -c config.yaml

 
• 这是一个用 Go 写的后端服务（Gin + ConnectRPC/gRPC），面向“恋爱/聊天翻译与咨询”场景。下面基于实际代码结构做个清晰的项目解读。
                                                                                                                                              
  总体定位                                                                                                                                    
                                                                                                                                              
  - 核心是“聊天历史管理 + AI 翻译/咨询 + 个人资料管理 + 图片聊天记录识别(OCR)”的后端。                                                        
  - 外部接口以 ConnectRPC 的 HTTP 形式对外暴露（proto 定义在 proto/，服务实现都在 app_server/service/）。                                     
  - DB 使用 GORM + MySQL，ID 基于 Snowflake 生成。                                                                                            
                                                                                                                                              
  启动与路由入口                                                                                                                              
                                                                                                                                              
  - 入口：app_server/cmd/api_server/main.go                                                                                                   
  - 初始化流程：加载配置 -> 初始化 DB -> OSS -> OpenAI/火山引擎客户端 -> JWT                                                                  
  - 路由绑定：Gin + Connect 适配器，将各服务绑定到 / 根路径，并加上鉴权与上下文拦截                                                           
  - 提供 /file/wx_upload 和 /ping                                                                                                             
                                                                                                                                              
  核心模块划分                                                                                                                                
                                                                                                                                              
  - 服务层：app_server/service/*                                                                                                              
  - 领域层（业务事务）：app_server/domain/*                                                                                                   
  - 数据模型：app_server/model/*                                                                                                              
  - 基础设施：app_server/pkg/*                                                                                                                
  - 协议定义：proto/*（通过 buf 生成到 app_server/proto/*）                                                                                   
                                                                                                                                              
  认证与上下文                                                                                                                                
                                                                                                                                              
  - JWT 解析与校验：app_server/service/auth/auth.go                                                                                           
  - Connect 拦截器统一注入 userId：app_server/service/auth/auth.go                                                                            
  - 透传客户端 X-App-* 头：app_server/service/ctx/ctx.go                                                                                      
                                                                                                                                              
  关键业务流（按场景）                                                                                                                        
                                                                                                                                              
  1. 用户登录/注册                                                                                                                            
                                                                                                                                              
  - 微信登录：app_server/service/user/user.go                                                                                                 
  - 在 DB 中 find or create：app_server/service/user/wx_login.go                                                                              
  - 用户初始化走 domain 层：app_server/domain/new_user.go（可结合该文件继续看初始化逻辑）                                                     
                                                                                                                                              
  2. 聊天会话                                                                                                                                 
                                                                                                                                              
  - CRUD：app_server/service/chat/chat.go                                                                                                     
  - 创建会话时会一起创建 profile：app_server/domain/chat_session.go                                                                           
                                                                                                                                              
  3. 消息管理（统一）                                                                                                                         
                                                                                                                                              
  - 合并“历史聊天 + AI 咨询 + AI 翻译”为统一 ChatMessage：app_server/service/message/chat_message.go                                          
  - List 逻辑会过滤旧翻译/旧咨询消息，并把翻译合并到 translate_content                                                                        
  - 发送咨询消息时会构造对话上下文并调用 AI：SendConsultMessage                                                                               
                                                                                                                                              
  4. AI 翻译                                                                                                                                  
                                                                                                                                              
  - 普通翻译：Translate in app_server/service/translate/translate.go                                                                          
  - 翻译朋友消息 + 自动保存翻译结果：TranslateFriendMessage                                                                                   
  - V2 翻译使用配置表模板并拼接 user/friend profile：TranslateV2                                                                              
                                                                                                                                              
  5. OCR 解析                                                                                                                                 
                                                                                                                                              
  - 图片识别由 OpenAI/火山引擎模型完成：app_server/pkg/aiapi/volcengine.go                                                                    
  - ParseImageMessages 会把 OCR 结果转成历史消息入库：app_server/service/message/chat_message.go                                              
                                                                                                                                              
  数据模型设计                                                                                                                                
                                                                                                                                              
  - 消息统一表：app_server/model/message.go                                                                                                   
      - msg_type 区分 HISTORY / TRANSLATE / CONSULT                                                                                           
      - role 区分 SELF / FRIEND / AI / USER                                                                                                   
      - 翻译消息通过 parent_id 指向原消息                                                                                                     
  - 会话/资料：app_server/model/chat.go, app_server/model/profile.go                                                                          
  - 用户：app_server/model/user.go                                                                                                            
                                                                                                                                              
  配置与基础设施                                                                                                                              
                                                                                                                                              
  - 配置加载：app_server/pkg/cfg/config.go                                                                                                    
  - DB 初始化 + 自定义雪花 ID：app_server/pkg/db/db.go                                                                                        
  - ID 生成：app_server/pkg/idgen/idgen.go                                                                                                    
  - AI 封装：app_server/pkg/oai/openai.go、app_server/pkg/openaic/client.go                                                                   
  - OSS：app_server/pkg/ossc/oss.go                                                                                                           
                                                                                                                                              
  接口形态                                                                                                                                    
                                                                                                                                              
  - ConnectRPC 接口路径类似：/chat.ChatService/ListChatSessions、/translate.TranslateService/Translate                                        
  - 接口声明可直接看 proto/*.proto                                                                                                            
                                                                                                                                              
  你可能关心的“项目核心逻辑点”                                                                                                                
                                                                                                                                              
  - 所有 AI 相关生成都落在 ChatMessage 表里（翻译/咨询统一一套消息模型）                                                                      
  - 翻译和咨询都在生成上下文时，会考虑历史消息与 profile                                                                                      
  - OCR 图片解析依赖 AI 返回“固定格式文本”，然后映射到角色/内容                                                                               
                                                                                                                                              
  快速指引（看源码顺序）                                                                                                                      
                                                                                                                                              
  1. 入口与路由：app_server/cmd/api_server/main.go                                                                                            
  2. 鉴权拦截：app_server/service/auth/auth.go                                                                                                
  3. 会话/消息/翻译主流程：                                                                                                                   
      - app_server/service/chat/chat.go                                                                                                       
      - app_server/service/message/chat_message.go                                                                                            
      - app_server/service/translate/translate.go                                                                                             
  4. 数据模型：app_server/model/message.go, app_server/model/chat.go, app_server/model/profile.go                                             
                                                                                                                                              
  如果你想更深入某条业务流程（比如“AI 咨询消息生成的上下文构造”、或“TranslateV2 的提示词模板逻辑”），告诉我具体点，我可以再拆分流程图或逐行解 
  释。