# Web 端重构实现方案（基于现有小程序）

## 1. 现有小程序结构概览（chat_wxmp-main）

**入口与配置**
- `app.js`: 启动时自动登录、拉取用户信息、触发性别选择流程。
- `app.json`: 页面路由配置，首页为 `pages/chat-sessions/index`。
- `utils/config.js`: 环境识别与 API_BASE_URL（当前含开发/生产分支）。

**页面与职责**
- `pages/chat-sessions/index`: 会话列表、创建/删除会话、进入会话。
- `pages/chat-sessions/create`: 会话创建页（与 index 中快速创建逻辑重复）。
- `pages/chat-detail/index`: 核心聊天页，包含消息列表、翻译、AI 咨询、反馈、复制、OCR 解析入口。
- `pages/profile/edit`: 资料编辑（头像上传、性别、简介、自定义标签）。
- `pages/profile/index`: 个人资料展示（辅助页）。
- `pages/gender-selection/index`: 首次登录性别选择。

**工具层**
- `utils/auth.js`: 小程序登录（wx.login -> `/user.UserService/WxUserLogin`）。
- `utils/request.js`: 统一请求封装（自动带 token）。
- `utils/user.js`: 用户与 profile 缓存/读取/更新。
- `utils/upload.js`: 文件上传（头像/图片）。
- `utils/avatar.js`: 头像显示逻辑（默认头像策略）。
- `utils/markdown.js`: AI 回复的 Markdown 解析。
- `utils/configManager.js`: 从配置接口拉取动态配置。

**对后端 API 的依赖**
- ChatService: `/chat.ChatService/ListChatSessions`、`CreateChatSession`、`DeleteChatSession`
- ChatMessageService: `ListChatMessages`、`CreateChatMessage`、`SendConsultMessage`、`FeedbackToMessage`、`ParseImageMessages`
- TranslateService: `TranslateV2`（主要使用）
- ProfileService: `GetProfile`、`CreateProfile`、`UpdateProfile`
- ConfigService: `GetConfig`

---

## 2. Web 端重构目标

1) 复刻现有小程序核心流程：登录 -> 会话 -> 消息/翻译/咨询 -> 资料编辑  
2) 复用现有 Go 后端（API 路径与鉴权保持一致）  
3) 提供更完整的浏览器交互（可复制、可滚动、可多设备）  
4) 保持 UI 行为一致（翻译折叠、AI 咨询、反馈、头像逻辑）

---

## 3. 技术选型建议

**前端：Next.js（推荐）**
- 优势：路由与页面结构天然对应小程序页面；SSR/CSR 混合；生态成熟。
- 适配：现有 API 为 ConnectRPC/HTTP POST，可直接用 fetch/axios。
- UI：建议选 TDesign React 或 Mantine/Chakra 作为组件库。

**后端：继续使用现有 Go 服务**
- 已包含业务逻辑（聊天、翻译、咨询、profile、文件上传等）。
- 已经接入登录与 token 体系，前端只需适配登录流程。

**结论**  
推荐：Next.js + 现有 Go 后端。  
不建议用 Next.js 作为后端替换 Go（现有业务已稳定，重写成本高）。

---

## 4. Web 端页面与路由映射

| 小程序页面 | Web 路由建议 | 说明 |
|---|---|---|
| `pages/chat-sessions/index` | `/sessions` | 会话列表与进入会话 |
| `pages/chat-sessions/create` | `/sessions/new` | 创建会话（可合并到列表弹窗） |
| `pages/chat-detail/index` | `/sessions/[id]` | 聊天详情 |
| `pages/profile/edit` | `/profile/edit` / `/profile/[id]/edit` | 资料编辑（自己/好友） |
| `pages/gender-selection/index` | `/profile/gender` | 首次登录性别选择 |

---

## 5. API 对接与鉴权方案（Web）

**鉴权**
- 小程序使用 `wx.login` -> `/user.UserService/WxUserLogin`。
- Web 建议使用 **手机号登录**（`/user.UserService/PhoneLogin`），先走 MVP。
- Token 存储建议：`localStorage` + 内存缓存（避免每次刷新丢失）。
- 所有请求添加 Header：
  - `Authorization: Bearer <token>`
  - `Connect-Protocol-Version: 1`

**请求封装（替代 `utils/request.js`）**
- Web 侧做一个 `request.ts`:
  - 统一 baseURL
  - 自动拼接 headers
  - 统一处理错误与提示

**API 列表（与小程序一致）**
- `/chat.ChatService/*`
- `/message.ChatMessageService/*`
- `/translate.TranslateService/*`
- `/profile.ProfileService/*`
- `/config.ConfigService/*`

---

## 6. 关键业务流程映射

**A. 登录与初始化**
1) Web 登录（手机号）  
2) `/user.UserService/GetUserProfile` 拉取用户信息  
3) 如果 profile 性别为空，引导到 `/profile/gender`

**B. 会话列表**
- `ListChatSessions` → UI 渲染
- 创建会话：`CreateChatSession`（带 profile name）
- 删除会话：`DeleteChatSession`

**C. 聊天详情**
- `ListChatMessages` 拉取消息
- 发送咨询：`SendConsultMessage`
- 翻译：`TranslateV2`（基于 messageId）
- 反馈：`FeedbackToMessage`
- OCR：`ParseImageMessages`（可后置到 v2）

**D. Profile 编辑**
- `GetProfile`
- `CreateProfile` / `UpdateProfile`
- 头像上传：`/file/upload`（同小程序逻辑）

---

## 7. UI/交互还原清单

**必须还原**
- 会话列表（含头像、滑动删除 → Web 用菜单/按钮替代）
- 聊天详情：
  - 消息时间排序
  - 翻译折叠/展开
  - AI 回复 Markdown 渲染
  - 复制消息
  - 点赞/点踩
  - 重新生成 AI 回复
- Profile 编辑（头像、性别、标签）

**可优化**
- 翻译/咨询按钮集中在消息右侧菜单（Web 交互更清晰）
- 会话列表支持搜索与筛选
- 资料编辑可拆分成表单区块

---

## 8. 技术实现细节建议（Next.js）

**目录结构建议**
```
src/
  app/                      # Next.js App Router
    sessions/
    profile/
  components/
  services/
    api.ts                  # request 封装
    auth.ts                 # token 管理
  features/
    chat/
    profile/
  styles/
```

**状态管理**
- 简单版：React Context + hooks（token、用户、profile）
- 复杂版：Zustand / Redux Toolkit（更清晰的业务分层）

**Markdown**
- 小程序使用 `utils/markdown.js`，Web 可用 `marked` 或 `react-markdown`

**头像策略**
- 复用 `utils/avatar.js` 逻辑，移植为 `avatar.ts`

---

## 9. 风险与差异处理

- **登录差异**：Web 无法使用 wx.login，需手机号登录或自建 OAuth。
- **请求域名**：Web 需要 CORS 放行（Go 后端已启用 `Access-Control-Allow-Origin: *`）。
- **小程序特有 API**：`wx.getSystemInfoSync` / `wx.onKeyboardHeightChange` 在 Web 需用 DOM/viewport 替代。
- **文件上传**：小程序 `wx.uploadFile` → Web 使用 `<input type="file">` + `fetch`.

---

## 10. 分阶段实施计划

**阶段 1（MVP）**
- 登录（手机号）
- 会话列表 + 创建/删除
- 聊天详情：消息列表 + 发送咨询 + 翻译 + 反馈
- Profile 编辑（基础字段）

**阶段 2（完善）**
- OCR 解析与图片上传
- 翻译/咨询 UI 优化
- 配置中心（ConfigService）联动

**阶段 3（体验优化）**
- 缓存与离线支持
- 消息分页/懒加载
- 更精细的错误提示与埋点

---

## 11. 交付物清单

- Next.js Web 项目代码
- API request 封装与类型定义
- 迁移后的页面与组件
- 与 Go 后端的联调说明

---

## 12. 是否需要新增 Web 后端？

**不需要。**  
- 现有 Go 后端已经完整覆盖业务能力。  
- Web 仅需重构前端层，直接对接现有 API 即可。  
- 如需 SEO/SSR 或聚合网关，可在 Next.js 做轻量 BFF，但非必需。
